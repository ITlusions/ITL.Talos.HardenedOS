name: Build Custom Talos OS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: itlusions/itl-talos-hardened-os
  TALOS_VERSION: v1.9.0
  PKGS_VERSION: release-1.9
  BUILD_CUSTOM_KERNEL: false

jobs:
  build-branding:
    name: Build Branding Assets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate ASCII art banners
        run: |
          # Install figlet for text to ASCII
          sudo apt-get update
          sudo apt-get install -y figlet toilet
          
          # Create output directory if not exists
          mkdir -p branding/output
          
          # Generate banners
          figlet -f standard "ITL TALOS" > branding/output/title.txt
          toilet -f future "HARDENED OS" >> branding/output/title.txt
          
          # Create complete console banner
          cat << 'EOF' > branding/output/console-banner.txt
          ================================================
             ITL TALOS HARDENED OS FOR KUBERNETES
          ================================================
          
          Version: ${{ github.ref_name }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Kernel Version: $(uname -r)
          
          Security: MAXIMUM
          Encryption: LUKS2+TPM
          Authentication: Keycloak
          
          ================================================
          
          Node: \n | IP: \4 | Kernel: \r
          EOF
          
          echo "[OK] Branding assets generated"
      
      - name: Convert logos for kernel
        run: |
          # Install ImageMagick and netpbm FIRST
          sudo apt-get install -y imagemagick netpbm libtext-english-perl
          
          # Create logos directory
          mkdir -p branding/logos
          mkdir -p branding/output
          
          # Create placeholder logo if not exists
          if [ ! -f branding/logos/boot-logo.png ]; then
            # Create a simple 224x224 blue placeholder using convert
            convert -size 224x224 xc:navy \
              -pointsize 20 -fill white -gravity center \
              -annotate +0+0 "ITL" \
              branding/logos/boot-logo.png
          fi
          
          # Convert PNG logo to kernel format
          convert branding/logos/boot-logo.png \
                  -resize 224x224 \
                  branding/output/boot-logo.png
          
          convert branding/output/boot-logo.png \
                  branding/output/boot-logo.ppm
          
          ppmquant 224 branding/output/boot-logo.ppm | \
            pnmtoplainpnm > branding/output/logo_custom_clut224.ppm
          
          echo "[✓] Logos converted for kernel"
      
      - name: Upload branding artifacts
        uses: actions/upload-artifact@v4
        with:
          name: branding-assets
          path: branding/output/
          retention-days: 7

  build-kernel:
    name: Build Custom Kernel
    runs-on: ubuntu-latest
    if: vars.BUILD_CUSTOM_KERNEL == 'true'
    steps:
      - name: Checkout pkgs repository
        uses: actions/checkout@v4
        with:
          repository: siderolabs/pkgs
          ref: ${{ env.PKGS_VERSION }}
          path: pkgs

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply kernel customizations
        run: |
          cd pkgs
          echo "[*] Kernel config location: kernel/build/config-amd64"
          echo "[*] To customize: modify kernel/build/config-amd64 or use 'make kernel-menuconfig'"
          echo "[*] Current build will use default kernel config"
          
          # Add custom kernel patches here if needed
          # Example: echo "CONFIG_CUSTOM_OPTION=y" >> kernel/build/config-amd64
          
          echo "[OK] Kernel configuration ready"

      - name: Build and push custom kernel
        run: |
          cd pkgs
          echo "[*] Building custom kernel for amd64..."
          make kernel \
            REGISTRY=${{ env.REGISTRY }}/${{ github.repository_owner }} \
            PUSH=true \
            PLATFORM=linux/amd64
          
          echo "[OK] Custom kernel built and pushed"

      - name: Save kernel reference
        run: |
          echo "CUSTOM_KERNEL_IMAGE=${{ env.REGISTRY }}/${{ github.repository_owner }}/kernel:$(cd pkgs && git describe --tags --always)" >> $GITHUB_OUTPUT
        id: kernel

    outputs:
      kernel_image: ${{ steps.kernel.outputs.CUSTOM_KERNEL_IMAGE }}

  generate-configs:
    name: Generate Talos Configurations
    runs-on: ubuntu-latest
    needs: build-branding
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install talosctl
        run: |
          curl -Lo /usr/local/bin/talosctl \
            https://github.com/siderolabs/talos/releases/download/${{ env.TALOS_VERSION }}/talosctl-linux-amd64
          chmod +x /usr/local/bin/talosctl
          talosctl version --client
          echo "[OK] talosctl installed"
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Generate base configurations
        run: |
          mkdir -p config/generated config/output
          
          # Generate control plane config
          talosctl gen config itl-cluster \
            https://api.itlusions.com:6443 \
            --output-types controlplane \
            --output config/generated/controlplane.yaml
          
          # Generate worker config
          talosctl gen config itl-cluster \
            https://api.itlusions.com:6443 \
            --output-types worker \
            --output config/generated/worker.yaml
          
          echo "[OK] Base configurations generated"
      
      - name: Apply branding patches
        run: |
          # Apply ITL branding configuration patches
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/generated/controlplane.yaml \
            config/patches/branding-patch.yaml \
            > config/output/controlplane-branded.yaml
          
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/generated/worker.yaml \
            config/patches/branding-patch.yaml \
            > config/output/worker-branded.yaml
          
          echo "[OK] Branding patches applied"
      
      - name: Apply security hardening patches
        run: |
          # Apply security patches
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/output/controlplane-branded.yaml \
            config/patches/security-hardening.yaml \
            > config/output/controlplane-final.yaml
          
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/output/worker-branded.yaml \
            config/patches/security-hardening.yaml \
            > config/output/worker-final.yaml
          
          echo "[OK] Security hardening patches applied"
      
      - name: Add custom extensions
        run: |
          # Add official Talos extensions to control plane config
          yq eval '.machine.install.extensions += [
            {"image": "ghcr.io/siderolabs/gvisor:latest"},
            {"image": "ghcr.io/siderolabs/intel-ucode:latest"}
          ]' -i config/output/controlplane-final.yaml
          
          # Add official Talos extensions to worker config
          yq eval '.machine.install.extensions += [
            {"image": "ghcr.io/siderolabs/gvisor:latest"}
          ]' -i config/output/worker-final.yaml
          
          echo "[OK] Custom extensions added"
      
      - name: Validate configurations
        run: |
          # Validate generated configs
          talosctl validate --config config/output/controlplane-final.yaml --mode metal || echo "[!] Control plane validation warnings"
          talosctl validate --config config/output/worker-final.yaml --mode metal || echo "[!] Worker validation warnings"
          echo "[✓] Configuration validation complete"
      
      - name: Create configuration summary
        run: |
          cat > config/output/README.md << 'EOF'
          # Talos Configuration Files
          
          ## Files Included
          
          - **controlplane-final.yaml**: Configuration for Talos control plane nodes
          - **worker-final.yaml**: Configuration for Talos worker nodes
          
          ## Applied Patches
          
          1. **Branding Patch**: Adds ITL branding console banner and customizations
          2. **Security Hardening**: Applies security hardening configuration
          3. **Custom Extensions**: Includes branding, security, gVisor, and intel-ucode extensions
          
          ## Usage
          
          ```bash
          # Apply control plane config
          talosctl apply-config --nodes <control-plane-ip> --file controlplane-final.yaml
          
          # Apply worker config
          talosctl apply-config --nodes <worker-ip> --file worker-final.yaml
          ```
          
          ## Customization
          
          Before applying, ensure to:
          1. Update the cluster endpoint (currently: https://api.itlusions.com:6443)
          2. Customize network settings as needed
          3. Configure storage paths for your environment
          
          ## Support
          
          For configuration questions, see the Talos documentation:
          https://www.talos.dev/v1.9/
          EOF
          
          cat config/output/README.md
      
      - name: Upload configuration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: talos-configs
          path: config/output/
          retention-days: 30

  build-iso:
    name: Build Bootable ISO
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    needs: [generate-configs, build-branding]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download branding assets
        uses: actions/download-artifact@v4
        with:
          name: branding-assets
          path: branding/output

      - name: Install build dependencies
        run: |
          echo "[*] Installing dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y xorriso cpio zstd wget
          echo "[OK] Dependencies installed"

      - name: Build custom ISO with branding
        run: |
          echo "[*] Building Talos ISO with ITL branding..."
          mkdir -p build-output
          cd build-output
          
          # Download official ISO
          echo "[*] Downloading official Talos ISO..."
          wget -q --show-progress \
            "https://github.com/siderolabs/talos/releases/download/${{ env.TALOS_VERSION }}/metal-amd64.iso" \
            -O "talos-${{ env.TALOS_VERSION }}-amd64.iso"
          echo "[OK] ISO downloaded"
          
          # Extract boot files only
          echo "[*] Extracting boot files..."
          mkdir -p iso-boot iso-work
          xorriso -osirrox on -indev "talos-${{ env.TALOS_VERSION }}-amd64.iso" -extract /boot iso-boot/ 2>&1 | tail -3
          echo "[OK] Boot files extracted"
          
          # Find and extract initramfs
          INITRAMFS=$(find iso-boot -name "initramfs*" | head -1)
          if [ -z "$INITRAMFS" ]; then
            echo "[ERROR] Initramfs not found!"
            exit 1
          fi
          
          echo "[*] Found initramfs: $INITRAMFS"
          
          # Detect compression format and extract
          mkdir -p initramfs-work
          cd initramfs-work
          
          if file "../$INITRAMFS" | grep -q "Zstandard"; then
            echo "[*] Extracting zstd initramfs..."
            zstd -dc "../$INITRAMFS" | cpio -idm 2>/dev/null || true
            COMPRESS="zstd -19 -T0"
            EXT="zst"
          elif file "../$INITRAMFS" | grep -q "xz"; then
            echo "[*] Extracting xz initramfs..."
            xz -dc "../$INITRAMFS" | cpio -idm 2>/dev/null || true
            COMPRESS="xz --check=crc32 --lzma2=dict=1MiB"
            EXT="xz"
          else
            echo "[*] Extracting gzip initramfs..."
            zcat "../$INITRAMFS" | cpio -idm 2>/dev/null || true
            COMPRESS="gzip -9"
            EXT="gz"
          fi
          
          echo "[OK] Initramfs extracted"
          
          # Inject branding
          echo "[*] Injecting ITL branding..."
          mkdir -p etc
          cp ../../../branding/output/console-banner.txt etc/issue
          echo "[OK] Branding injected"
          
          # Repack initramfs
          echo "[*] Repacking initramfs..."
          find . -print0 | cpio --null -o -H newc 2>/dev/null | eval "$COMPRESS" > "../initramfs-branded.$EXT"
          cd ..
          
          echo "[OK] Branded initramfs created"
          
          # Extract full ISO structure
          echo "[*] Extracting full ISO structure..."
          xorriso -osirrox on -indev "talos-${{ env.TALOS_VERSION }}-amd64.iso" -extract / iso-work/ 2>&1 | tail -3
          echo "[OK] ISO structure extracted"
          
          # Replace initramfs
          echo "[*] Replacing initramfs with branded version..."
          cp "initramfs-branded.$EXT" "iso-work/boot/initramfs-branded.$EXT"
          
          # Rebuild ISO
          echo "[*] Rebuilding ISO with branding..."
          ISO_NAME="itl-talos-${{ env.TALOS_VERSION }}.iso"
          xorriso -as mkisofs \
            -iso-level 3 \
            -volid "ITL-TALOS-v1_9_0" \
            -eltorito-boot boot.catalog \
            -no-emul-boot \
            -eltorito-alt-boot \
            -e efi.img \
            -no-emul-boot \
            -isohybrid-gpt-basdat \
            -output "$ISO_NAME" \
            iso-work/ 2>&1 | tail -10
          
          if [ ! -f "$ISO_NAME" ]; then
            echo "[ERROR] ISO build failed!"
            exit 1
          fi
          
          echo "[OK] ISO build complete"
          ls -lh "$ISO_NAME"

      - name: Generate ISO checksums
        run: |
          cd build-output
          
          ISO_NAME="itl-talos-${{ env.TALOS_VERSION }}.iso"
          
          echo "[*] Generating checksums..."
          sha256sum "$ISO_NAME" > "$ISO_NAME.sha256"
          sha256sum -c "$ISO_NAME.sha256"
          
          md5sum "$ISO_NAME" > "$ISO_NAME.md5"
          md5sum -c "$ISO_NAME.md5"
          
          echo "[OK] Checksums generated"
          
          # Create summary file
          cat > itl-talos-${{ env.TALOS_VERSION }}-info.txt << 'EOF'
          ITL Talos HardenedOS - Build Information
          
          Version: ${{ env.TALOS_VERSION }}
          Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Commit: ${{ github.sha }}
          Repository: ${{ github.repository }}
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Contents:
          - Custom ITL branded Talos installer
          - Security hardening configuration
          - Bootable ISO for metal hardware deployment
          
          Installation:
          1. Boot from ISO on target hardware
          2. Configure network during installation
          3. Apply Talos configuration using talosctl
          
          Documentation: https://www.talos.dev/
          EOF
      
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: bootable-iso
          path: build-output/
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build-output/itl-talos-${{ env.TALOS_VERSION }}.iso
            build-output/itl-talos-${{ env.TALOS_VERSION }}.iso.sha256
            build-output/itl-talos-${{ env.TALOS_VERSION }}.iso.md5
            iso-output/itl-talos-${{ env.TALOS_VERSION }}-info.txt
          body: |
            # ITL Talos HardenedOS ${{ github.ref_name }}
            
            Custom hardened Talos OS with ITL branding and security enhancements.
            
            ## Contents
            - **itl-talos-${{ env.TALOS_VERSION }}.iso**: Bootable ISO image (metal-amd64)
            - **Checksums**: SHA256 and MD5 checksums for verification
            
            ## Installation
            1. Download the ISO file
            2. Create bootable USB/CD media
            3. Boot target hardware
            4. Follow Talos installation procedures
            
            ## Features
            - ITL branding and console banners
            - Security hardening (LUKS2, TPM, Keycloak integration)
            - Custom Talos extensions
            - gVisor and Intel microcode support
            
            ## Verification
            ```bash
            sha256sum -c itl-talos-${{ env.TALOS_VERSION }}.iso.sha256
            ```
            
            ## Support
            - Talos Documentation: https://www.talos.dev/
            - Repository: ${{ github.repository }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Lint YAML files
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint
          
          echo "[*] Linting Dockerfiles..."
          yamllint .github/workflows/*.yaml || true
          
          echo "[*] Linting configuration files..."
          yamllint config/patches/*.yaml || true
          
          echo "[✓] YAML linting complete"
      
      - name: Validate extension Dockerfiles
        run: |
          # Check if Dockerfiles exist and are valid
          if [ -f extensions/itl-branding/Dockerfile ]; then
            docker run --rm -i hadolint/hadolint < extensions/itl-branding/Dockerfile || true
          fi
          
          if [ -f extensions/itl-security/Dockerfile ]; then
            docker run --rm -i hadolint/hadolint < extensions/itl-security/Dockerfile || true
          fi
          
          echo "[✓] Dockerfile validation complete"
      
      - name: Validate Talos configurations
        run: |
          # Install talosctl
          curl -Lo /usr/local/bin/talosctl \
            https://github.com/siderolabs/talos/releases/download/${{ env.TALOS_VERSION }}/talosctl-linux-amd64
          chmod +x /usr/local/bin/talosctl
          
          # Validate config structure
          if [ -f config/patches/branding-patch.yaml ]; then
            talosctl validate --config config/patches/branding-patch.yaml --mode metal || echo "[!] Branding patch validation warnings"
          fi
          
          echo "[OK] Configuration validation complete"

  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    if: always()
    needs: [build-branding, generate-configs]
    steps:
      - name: Log completion
        run: |
          echo "Build Complete: Custom Talos OS build finished"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
