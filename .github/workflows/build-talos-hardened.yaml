name: Build Custom Talos OS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: itlusions/itl-talos-hardened-os
  TALOS_VERSION: v1.9.0
  PKGS_VERSION: release-1.9
  BUILD_CUSTOM_KERNEL: false

jobs:
  generate-configs:
    name: Generate Talos Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install talosctl
        run: |
          curl -Lo /usr/local/bin/talosctl \
            https://github.com/siderolabs/talos/releases/download/${{ env.TALOS_VERSION }}/talosctl-linux-amd64
          chmod +x /usr/local/bin/talosctl
          talosctl version --client
          echo "[OK] talosctl installed"
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Generate base configurations
        run: |
          mkdir -p config/generated config/output
          
          # Generate control plane config
          talosctl gen config itl-cluster \
            https://api.itlusions.com:6443 \
            --output-types controlplane \
            --output config/generated/controlplane.yaml
          
          # Generate worker config
          talosctl gen config itl-cluster \
            https://api.itlusions.com:6443 \
            --output-types worker \
            --output config/generated/worker.yaml
          
          echo "[OK] Base configurations generated"
      
      - name: Apply branding patches
        run: |
          # Apply ITL branding configuration patches
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/generated/controlplane.yaml \
            config/patches/branding-patch.yaml \
            > config/output/controlplane-branded.yaml
          
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/generated/worker.yaml \
            config/patches/branding-patch.yaml \
            > config/output/worker-branded.yaml
          
          echo "[OK] Branding patches applied"
      
      - name: Apply security hardening patches
        run: |
          # Apply security patches
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/output/controlplane-branded.yaml \
            config/patches/security-hardening.yaml \
            > config/output/controlplane-final.yaml
          
          yq eval-all 'select(fileIndex == 0) * select(fileIndex == 1)' \
            config/output/worker-branded.yaml \
            config/patches/security-hardening.yaml \
            > config/output/worker-final.yaml
          
          echo "[OK] Security hardening patches applied"
      
      - name: Add custom extensions
        run: |
          # Add official Talos extensions to control plane config
          yq eval '.machine.install.extensions += [
            {"image": "ghcr.io/siderolabs/gvisor:latest"},
            {"image": "ghcr.io/siderolabs/intel-ucode:latest"}
          ]' -i config/output/controlplane-final.yaml
          
          # Add official Talos extensions to worker config
          yq eval '.machine.install.extensions += [
            {"image": "ghcr.io/siderolabs/gvisor:latest"}
          ]' -i config/output/worker-final.yaml
          
          echo "[OK] Custom extensions added"
      
      - name: Validate configurations
        run: |
          # Validate generated configs
          talosctl validate --config config/output/controlplane-final.yaml --mode metal || echo "[!] Control plane validation warnings"
          talosctl validate --config config/output/worker-final.yaml --mode metal || echo "[!] Worker validation warnings"
          echo "[✓] Configuration validation complete"
      
      - name: Create configuration summary
        run: |
          cat > config/output/README.md << 'EOF'
          # Talos Configuration Files
          
          ## Files Included
          
          - **controlplane-final.yaml**: Configuration for Talos control plane nodes
          - **worker-final.yaml**: Configuration for Talos worker nodes
          
          ## Applied Patches
          
          1. **Branding Patch**: Adds ITL branding console banner and customizations
          2. **Security Hardening**: Applies security hardening configuration
          3. **Custom Extensions**: Includes branding, security, gVisor, and intel-ucode extensions
          
          ## Usage
          
          ```bash
          # Apply control plane config
          talosctl apply-config --nodes <control-plane-ip> --file controlplane-final.yaml
          
          # Apply worker config
          talosctl apply-config --nodes <worker-ip> --file worker-final.yaml
          ```
          
          ## Customization
          
          Before applying, ensure to:
          1. Update the cluster endpoint (currently: https://api.itlusions.com:6443)
          2. Customize network settings as needed
          3. Configure storage paths for your environment
          
          ## Support
          
          For configuration questions, see the Talos documentation:
          https://www.talos.dev/v1.9/
          EOF
          
          cat config/output/README.md
      
      - name: Upload configuration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: talos-configs
          path: config/output/
          retention-days: 30

  build-iso:
    name: Build Bootable ISO
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    needs: [generate-configs]
    steps:
      - name: Install build dependencies
        run: |
          echo "[*] Installing dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y xorriso cpio zstd wget
          echo "[OK] Dependencies installed"

      - name: Run build-simple.sh to create ISO
        run: |
          echo "[*] Running build-simple.sh script..."
          chmod +x ./build-simple.sh
          ./build-simple.sh
          echo "[OK] Build script completed"
          
          # Copy output to expected location
          mkdir -p build-output
          cp -v itl-talos-${{ env.TALOS_VERSION }}.iso build-output/ || true

      - name: Generate ISO checksums
        run: |
          cd build-output
          
          ISO_NAME="itl-talos-${{ env.TALOS_VERSION }}.iso"
          
          echo "[*] Generating checksums..."
          sha256sum "$ISO_NAME" > "$ISO_NAME.sha256"
          sha256sum -c "$ISO_NAME.sha256"
          
          md5sum "$ISO_NAME" > "$ISO_NAME.md5"
          md5sum -c "$ISO_NAME.md5"
          
          echo "[OK] Checksums generated"
          
          # Create summary file
          cat > itl-talos-${{ env.TALOS_VERSION }}-info.txt << 'EOF'
          ITL Talos HardenedOS - Build Information
          
          Version: ${{ env.TALOS_VERSION }}
          Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Commit: ${{ github.sha }}
          Repository: ${{ github.repository }}
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Contents:
          - Custom ITL branded Talos installer
          - Security hardening configuration
          - Bootable ISO for metal hardware deployment
          
          Installation:
          1. Boot from ISO on target hardware
          2. Configure network during installation
          3. Apply Talos configuration using talosctl
          
          Documentation: https://www.talos.dev/
          EOF
      
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: bootable-iso
          path: build-output/
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build-output/itl-talos-${{ env.TALOS_VERSION }}.iso
            build-output/itl-talos-${{ env.TALOS_VERSION }}.iso.sha256
            build-output/itl-talos-${{ env.TALOS_VERSION }}.iso.md5
            iso-output/itl-talos-${{ env.TALOS_VERSION }}-info.txt
          body: |
            # ITL Talos HardenedOS ${{ github.ref_name }}
            
            Custom hardened Talos OS with ITL branding and security enhancements.
            
            ## Contents
            - **itl-talos-${{ env.TALOS_VERSION }}.iso**: Bootable ISO image (metal-amd64)
            - **Checksums**: SHA256 and MD5 checksums for verification
            
            ## Installation
            1. Download the ISO file
            2. Create bootable USB/CD media
            3. Boot target hardware
            4. Follow Talos installation procedures
            
            ## Features
            - ITL branding and console banners
            - Security hardening (LUKS2, TPM, Keycloak integration)
            - Custom Talos extensions
            - gVisor and Intel microcode support
            
            ## Verification
            ```bash
            sha256sum -c itl-talos-${{ env.TALOS_VERSION }}.iso.sha256
            ```
            
            ## Support
            - Talos Documentation: https://www.talos.dev/
            - Repository: ${{ github.repository }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Lint YAML files
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint
          
          echo "[*] Linting Dockerfiles..."
          yamllint .github/workflows/*.yaml || true
          
          echo "[*] Linting configuration files..."
          yamllint config/patches/*.yaml || true
          
          echo "[✓] YAML linting complete"
      
      - name: Validate extension Dockerfiles
        run: |
          # Check if Dockerfiles exist and are valid
          if [ -f extensions/itl-branding/Dockerfile ]; then
            docker run --rm -i hadolint/hadolint < extensions/itl-branding/Dockerfile || true
          fi
          
          if [ -f extensions/itl-security/Dockerfile ]; then
            docker run --rm -i hadolint/hadolint < extensions/itl-security/Dockerfile || true
          fi
          
          echo "[✓] Dockerfile validation complete"
      
      - name: Validate Talos configurations
        run: |
          # Install talosctl
          curl -Lo /usr/local/bin/talosctl \
            https://github.com/siderolabs/talos/releases/download/${{ env.TALOS_VERSION }}/talosctl-linux-amd64
          chmod +x /usr/local/bin/talosctl
          
          # Validate config structure
          if [ -f config/patches/branding-patch.yaml ]; then
            talosctl validate --config config/patches/branding-patch.yaml --mode metal || echo "[!] Branding patch validation warnings"
          fi
          
          echo "[OK] Configuration validation complete"

  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    if: always()
    needs: [generate-configs]
    steps:
      - name: Log completion
        run: |
          echo "Build Complete: Custom Talos OS build finished"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
